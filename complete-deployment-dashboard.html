<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ataraxia Deployment Command Center</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-card: #161b22;
            --border-color: #30363d;
            --accent-primary: #58a6ff;
            --accent-success: #238636;
            --accent-danger: #da3633;
            --accent-warning: #d29922;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo svg {
            width: 32px;
            height: 32px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge.connected {
            background-color: rgba(35, 134, 54, 0.2);
            color: #3fb950;
            border: 1px solid rgba(35, 134, 54, 0.5);
        }

        .status-badge.disconnected {
            background-color: rgba(218, 54, 51, 0.2);
            color: #f85149;
            border: 1px solid rgba(218, 54, 51, 0.5);
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .col-4 {
            grid-column: span 4;
        }

        .col-6 {
            grid-column: span 6;
        }

        .col-8 {
            grid-column: span 8;
        }

        .col-12 {
            grid-column: span 12;
        }

        @media (max-width: 1200px) {
            .col-6 {
                grid-column: span 12;
            }
        }

        /* Controls */
        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        select {
            width: 100%;
            padding: 8px 12px;
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background-color: var(--accent-success);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2ea043;
        }

        .btn-blue {
            background-color: #1f6feb;
            color: white;
        }

        .btn-blue:hover {
            background-color: #388bfd;
        }

        .btn-danger {
            background-color: var(--bg-card);
            color: var(--accent-danger);
            border-color: var(--border-color);
        }

        .btn-danger:hover {
            background-color: rgba(218, 54, 51, 0.1);
        }

        /* Status Grid */
        .status-monitor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status-indicator {
            background-color: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .status-indicator .value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .status-indicator .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Logs - BIGGER AND FULL WIDTH */
        .logs-container {
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            height: 600px;
            /* Increased height */
            overflow-y: auto;
            padding: 20px;
            /* More padding */
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            /* Larger font */
            white-space: pre-wrap;
            /* Better wrapping */
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.5;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
            /* Subtle separator */
            padding-bottom: 2px;
        }

        .log-time {
            color: var(--text-secondary);
            min-width: 100px;
            font-size: 0.85rem;
        }

        .log-msg {
            word-break: break-word;
            flex: 1;
        }

        .log-info {
            color: var(--text-primary);
        }

        .log-success {
            color: #3fb950;
        }

        .log-warning {
            color: var(--accent-warning);
        }

        .log-error {
            color: #f85149;
        }

        /* API Grid */
        .api-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
        }

        .api-item {
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .api-status-dot {
            margin-left: auto;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
        }

        .api-status-dot.success {
            background-color: #3fb950;
            box-shadow: 0 0 5px rgba(63, 185, 80, 0.4);
        }

        .api-status-dot.error {
            background-color: #f85149;
            box-shadow: 0 0 5px rgba(248, 81, 73, 0.4);
        }

        /* Two Column Layout Helper */
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .split-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
                Ataraxia Command Center
            </div>
            <div class="status-badge" id="connectionStatus">
                <div class="pulse"></div>
                <span id="connText">Connecting...</span>
            </div>
        </header>

        <div class="grid">
            <!-- Top Role: Operations & Status -->

            <!-- Left Half: Operations -->
            <div class="col-6">
                <!-- Local -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2>üñ•Ô∏è Local Environment</h2>
                    <div class="control-group">
                        <label>Service Target</label>
                        <select id="localService">
                            <option value="all">Full Stack (All Services)</option>
                            <option value="therapist">Therapist Service</option>
                            <option value="auth">Auth Service</option>
                            <option value="client">Client Service</option>
                            <option value="verification">Verification Service</option>
                            <option value="api-explorer">API Explorer UI</option>
                        </select>
                    </div>
                    <div class="split-layout">
                        <div class="btn-group">
                            <button class="btn-primary" onclick="startLocal()">Start Local Dev</button>
                            <button class="btn-danger" onclick="stopLocal()">Stop</button>
                        </div>
                        <div class="status-monitor">
                            <div class="status-indicator">
                                <div class="value" id="localStatusDisplay" style="color: var(--text-secondary);">Stopped
                                </div>
                                <div class="label">Status</div>
                            </div>
                            <div class="status-indicator">
                                <div class="value" id="portDisplay">--</div>
                                <div class="label">Port</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cloud -->
                <div class="card">
                    <h2>‚òÅÔ∏è AWS Cloud Deployment</h2>
                    <div class="control-group">
                        <label>Stack Target</label>
                        <select id="cloudService">
                            <option value="all">Complete Production Stack</option>
                            <option value="therapist">Therapist Lambda</option>
                            <option value="auth">Auth Lambda</option>
                            <option value="infrastructure">Core Infrastructure</option>
                        </select>
                    </div>
                    <div class="split-layout">
                        <div class="btn-group">
                            <button class="btn-blue" onclick="startCloud()">Deploy</button>
                            <button class="btn-danger" onclick="stopCloud()">Abort</button>
                        </div>
                        <div class="status-monitor">
                            <div class="status-indicator">
                                <div class="value" id="cloudStatusDisplay" style="color: var(--text-secondary);">Idle
                                </div>
                                <div class="label">Cloud Status</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Half: Monitoring -->
            <div class="col-6">
                <div class="card" style="margin-bottom: 20px;">
                    <h2>‚ù§Ô∏è System Health</h2>
                    <div class="api-grid">
                        <div class="api-item"><span>Postgres DB</span>
                            <div class="api-status-dot" id="dbDot"></div>
                        </div>
                        <div class="api-item"><span>Cognito Auth</span>
                            <div class="api-status-dot" id="authDot"></div>
                        </div>
                        <div class="api-item"><span>API Gateway</span>
                            <div class="api-status-dot" id="apiDot"></div>
                        </div>
                    </div>
                    <button class="btn-blue" style="margin-top: 15px; width: 100%;" onclick="runHealthCheck()">Run
                        Diagnostics</button>
                </div>

                <div class="split-layout">
                    <div class="card" style="height: 100%;">
                        <h2>üìã Verification Queue <span
                                style="font-size: 0.75rem; background: var(--accent-primary); color: #000; padding: 2px 6px; border-radius: 10px; margin-left: auto;">Live</span>
                        </h2>
                        <div id="verificationQueue"
                            style="font-size: 0.85rem; color: var(--text-secondary); text-align: center; padding: 20px;">
                            Waiting for live data...
                        </div>
                    </div>

                    <div class="card" style="height: 100%;">
                        <h2>üîó Quick Links</h2>
                        <a href="/api-explorer.html" target="_blank"
                            style="display: block; padding: 12px; background: #0d1117; border: 1px solid var(--border-color); border-radius: 6px; text-decoration: none; color: var(--accent-primary); text-align: center; font-weight: 600;">
                            Open API Explorer ‚Üó
                        </a>
                        <div
                            style="margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
                            Use Explorer to test endpoints manually.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Logs (Full Width) -->
            <div class="col-12">
                <div class="card" style="height: 100%;">
                    <h2>
                        üìù System Logs
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <span
                                style="font-size: 0.75rem; color: var(--text-secondary); padding-top: 2px;">Auto-scrolling
                                enabled</span>
                            <button onclick="clearLogs()"
                                style="padding: 4px 12px; font-size: 0.75rem; background: transparent; border: 1px solid var(--border-color); color: var(--text-primary);">Clear
                                Logs</button>
                        </div>
                    </h2>
                    <div class="logs-container" id="logsContainer">
                        <div class="log-entry log-info"><span class="log-time">System</span><span
                                class="log-msg">Dashboard initialized. Layout updated for max visibility.</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Config
        const API_URL = 'http://localhost:3012';
        const WS_URL = 'ws://localhost:3012';
        let ws;

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            connectWs();
            pollStatus();
        });

        function connectWs() {
            const statusBadge = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connText');

            try {
                ws = new WebSocket(WS_URL);
                ws.onopen = () => {
                    statusBadge.className = 'status-badge connected';
                    statusText.textContent = 'Connected';
                    log('System', 'WebSocket connected', 'success');
                };
                ws.onclose = () => {
                    statusBadge.className = 'status-badge disconnected';
                    statusText.textContent = 'Disconnected';
                    log('System', 'WebSocket disconnected. Retrying...', 'warning');
                    setTimeout(connectWs, 3000);
                };
                ws.onmessage = (e) => {
                    const msg = JSON.parse(e.data);
                    if (msg.type === 'log') {
                        log(msg.data.type, msg.data.message, msg.data.level);
                    } else if (msg.type === 'state') {
                        updateState(msg.data);
                    }
                };
            } catch (e) {
                console.error(e);
            }
        }

        function updateState(state) {
            // Local
            const localStatus = document.getElementById('localStatusDisplay');
            localStatus.textContent = state.local.status.toUpperCase();
            localStatus.style.color = state.local.status === 'running' ? '#3fb950' : '#8b949e';
            document.getElementById('portDisplay').textContent = state.local.port || '--';

            // Cloud
            const cloudStatus = document.getElementById('cloudStatusDisplay');
            cloudStatus.textContent = state.cloud.status.toUpperCase();
            cloudStatus.style.color = state.cloud.status === 'deployed' ? '#3fb950' :
                state.cloud.status === 'deploying' ? '#d29922' : '#8b949e';

            // Health
            setDot('dbDot', state.database.status === 'connected');
            setDot('apiDot', state.api.status === 'healthy');
        }

        function setDot(id, success) {
            const el = document.getElementById(id);
            el.className = `api-status-dot ${success ? 'success' : 'error'}`;
        }

        function log(source, msg, level = 'info') {
            const container = document.getElementById('logsContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const colorClass = `log-${level}`;

            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-msg ${colorClass}">${msg}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logsContainer').innerHTML = '';
        }

        // Actions
        async function startLocal() {
            const service = document.getElementById('localService').value;
            await fetch(`${API_URL}/api/deployment/local/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service })
            });
        }

        async function stopLocal() {
            await fetch(`${API_URL}/api/deployment/local/stop`, { method: 'POST' });
        }

        async function startCloud() {
            const service = document.getElementById('cloudService').value;
            await fetch(`${API_URL}/api/deployment/cloud/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service })
            });
        }

        async function stopCloud() {
            await fetch(`${API_URL}/api/deployment/cloud/stop`, { method: 'POST' });
        }

        async function runHealthCheck() {
            log('Diagnostics', 'Running health checks...', 'info');
            try {
                const res = await fetch(`${API_URL}/api/status`);
                const data = await res.json();
                await fetch(`${API_URL}/api/test-endpoints`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
            } catch (e) {
                log('Diagnostics', 'Health check failed', 'error');
            }
        }

        async function pollStatus() {
            try {
                const res = await fetch(`${API_URL}/api/status`);
                const data = await res.json();
                const queue = document.getElementById('verificationQueue');
                queue.textContent = "No pending verifications found.";
            } catch (e) { }
        }
    </script>
</body>

</html>